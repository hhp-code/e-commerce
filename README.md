# K6 부하테스트

## K6 부하 테스트 개요

### 테스트 환경
- **CPU**: 4G
- **메모리**: 8G

### 테스트 대상
- 주문 결제 API
- 주문 생성 API
- 주문 조회 API

### 테스트 목적
- 시스템의 최대 처리 용량 파악
- 응답 시간 및 처리량 측정
- 병목 지점 식별
- 200TPS 부하에 대한 안전성 보장

### 테스트 시나리오
1. 부하 테스트
2. 내구성 테스트
3. 스트레스 테스트
4. 최고 부하 테스트 (스파이크 테스트)

## 테스트 실행 문제 및 해결 과정
![스크린샷 2024-08-19 22 41 09](https://github.com/user-attachments/assets/6fc7f7e4-da31-4ce2-85a3-4bbb303ec27f)
![스크린샷 2024-08-20 10 17 59](https://github.com/user-attachments/assets/47d6b80e-4941-46b1-bebb-e34885547952)

1. 초기 실행 시 데드락 발생
   - 원인: 'User' 도메인 변경에 동시성 문제
   - 해결: 락 적용 후 재시도

2. 하이버네이트 관련 예외 발생
   - IllegalStateException 및 NullPointerException 발생
   - 원인: 하이버네이트의 스레드 안전성 문제

3. 데드락 해결을 위한 설계 변경
   - 주문->유저 참조 방식 변경
   - 컨트롤러 스펙변경을 통해 유저번호, 주문번호를 통한 변경 방식 도입

4. 서버 스펙 업그레이드
   - 2CPU 4G에서 4CPU 8G로 변경

5. 도커 컴포즈 도입
   - 단일 도커파일 사용에서 도커 컴포즈로 전환

## 테스트 결과 분석
![스크린샷 2024-08-20 12 18 03](https://github.com/user-attachments/assets/011747eb-fab6-4a33-a9fd-f4a4f2b2174a)

### 응답 시간
- 평균: 10.4ms
- 중앙값: 7.48ms
- 최소: 990μs
- 최대: 757.78ms
- 90번째 백분위수: 20.42ms
- 95번째 백분위수: 26.15ms

### 요청 처리량
- 총 처리 요청: 458,616
- 초당 요청 처리량: 141.457939/s

### 오류율
- http_req_failed: 0.00%

### 추가 정보
- 최대 가상 사용자 수: 550명
- 테스트 실행 시간: 54분 2.1초
- 총 반복 횟수: 114,654회


## 분석
1. **성능 목표 달성**:
   - 목표했던 200 TPS에 근접한 141 TPS를 달성했습니다.

2. **시스템 안정성**:
   - 오류율 0%
   - 평균 응답 시간 10.4ms

3. **확장성**:
   - 최대 550명의 동시 사용자를 처리할 수 있었습니다.

4. **예상 일일 사용자 수**:
   - 약 30만~35만 명의 일일 활성 사용자(DAU)를 안정적으로 지원할 수 있을 것으로 추정됩니다.
   - 이는 사용자당 평균 30개의 요청을 한다고 가정했을 때의 보수적인 추정치입니다.

## 개선
#### 테스트 스크립트 수정 및 추가
- 테스트 시나리오 200TPS 이상으로 요청

![스크린샷 2024-08-20 12 18 03](https://github.com/user-attachments/assets/f298eb26-68c8-46fe-8bd1-b670c5c53813)
1. **성능 목표 달성**:
   - 목표했던 200 TPS를 크게 초과하여 580.496062 TPS 달성

2. **시스템 안정성**:
   - 오류율 0%
   - 평균 응답 시간 6.44ms

3. **확장성**:
   - 최대 300명의 동시 사용자를 처리할 수 있었습니다.
   - 이는 실제 운영 환경에서 대규모 트래픽을 효과적으로 감당할 수 있음을 의미합니다.

4. **예상 일일 사용자 수**:
   - 약 125만 명의 일일 활성 사용자(DAU)를 안정적으로 지원할 수 있을 것으로 추정됩니다.
   - 이는 사용자당 평균 50개의 요청을 한다고 가정했을 때의 계산 결과입니다.

5. **추가 성능 지표**:
   - 데이터 처리량: 수신 125 kB/s, 송신 89 kB/s
   - 95번째 백분위수 응답 시간: 8.36ms
